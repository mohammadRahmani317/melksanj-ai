<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>نمودار قیمت املاک</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<!-- Header -->
<header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">سامانه تحلیل املاک دیوار</h1>
        <nav class="space-x-2 space-x-reverse">
            <a href="index.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">خانه</a>
            <a href="charts.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">نمودارهای
                تحلیلی</a>
            <a href="predict.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">تخمین قیمت</a>
        </nav>
    </div>
</header>

<body class="bg-gradient-to-b from-blue-100 to-blue-50 min-h-screen font-sans pb-20">

<div class="max-w-3xl mx-auto mt-4 bg-white p-4 rounded-2xl shadow text-sm leading-tight">
    <h4 class="text-2xl font-bold mb-6 text-center">نمودار تغییرات قیمت املاک</h4>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" dir="rtl">
        <div>
            <label class="block mb-1 font-medium">شهر</label>
            <select id="citySelect" class="w-full border p-2 rounded"></select>
        </div>
        <div>
            <label class="block mb-1 font-medium">نوع آگهی</label>
            <select id="groupSelect" class="w-full border p-2 rounded">
                <option value="">همه</option>
            </select>
        </div>
        <div>
            <label class="block mb-1 font-medium">نوع ملک</label>
            <select id="categorySelect" class="w-full border p-2 rounded">
                <option value="">همه</option>
            </select>
        </div>
    </div>

    <button onclick="loadChart()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded mb-4 w-full">نمایش
        نمودار
    </button>

    <!-- 👇 تغییر ارتفاع نمودار -->
    <canvas id="priceChart" height="100"></canvas>
</div>

<script>
    let chart;

    async function fetchData() {
        const [cities, groups, categories] = await Promise.all([
            fetch('http://localhost:8080/rest/reale/state/cities').then(res => res.json()),
            fetch('http://localhost:8080/rest/reale/state/groups').then(res => res.json()),
            fetch('http://localhost:8080/rest/reale/state/categories').then(res => res.json())
        ]);

        fillSelect(document.getElementById("citySelect"), cities, "id", "name");
        fillSelect(document.getElementById("groupSelect"), groups, "code", "title", true);
        fillSelect(document.getElementById("categorySelect"), categories, "code", "title", true);
    }

    function fillSelect(select, data, valueKey, textKey, addAllOption = false) {
        select.innerHTML = "";
        if (addAllOption) {
            const allOption = document.createElement("option");
            allOption.value = "";
            allOption.textContent = "همه";
            select.appendChild(allOption);
        }

        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item[valueKey];
            opt.textContent = item[textKey];
            select.appendChild(opt);
        });
    }

    async function loadChart() {
        const cityId = document.getElementById("citySelect").value;
        const groupCode = document.getElementById("groupSelect").value;
        const categoryCode = document.getElementById("categorySelect").value;

        if (!cityId) {
            alert("لطفاً یک شهر انتخاب کنید");
            return;
        }

        let url = `http://localhost:8080/rest/reale/state/chart?cityId=${cityId}`;
        if (groupCode) url += `&groupCode=${groupCode}`;
        if (categoryCode) url += `&categoryCode=${categoryCode}`;

        try {
            const data = await fetch(url).then(res => res.json());

            const labels = Object.keys(data);
            const values = Object.values(data).map(Number);

            // محاسبه کمترین و بیشترین مقدار
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);

            // کم و زیاد کردن محدوده
            const minY = Math.max(0, Math.floor(minValue) - 2); // حداقل ۰
            const maxY = Math.ceil(maxValue) + 2;

            if (chart) chart.destroy();

            const ctx = document.getElementById("priceChart").getContext("2d");
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "میانگین قیمت (میلیارد تومان)",
                        data: values,
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: minY,
                            maxY: maxY,
                            ticks: {
                                callback: function (value, index, values) {
                                    // از بین بردن اعشار با استفاده از Math.round و فرمت هزارگان
                                    return new Intl.NumberFormat('fa-IR').format(Math.round(value)) + ' میلیارد';
                                },

                                stepSize: 1,
                            },
                            title: {
                                display: true,
                                text: "قیمت به میلیارد تومان"
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: "سال شمسی"
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw} میلیارد تومان`
                            }
                        }
                    }
                }
            });
        } catch (e) {
            alert("خطا در بارگذاری نمودار");
            console.error(e);
        }
    }

    window.onload = fetchData;
</script>

<!-- Footer -->
<footer class="bg-gray-800 text-white py-4 w-full text-center fixed bottom-0 left-0">
    <div class="max-w-6xl mx-auto">
        <p class="text-sm">
            داده‌های این سایت بر اساس آگهی‌های املاک منتشر شده در دیوار است. تمامی حقوق مربوط به این داده‌ها متعلق به
            دیوار است.
        </p>
    </div>
</footer>

</body>
</html>
