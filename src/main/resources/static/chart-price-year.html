<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ù…ÙˆØ¯Ø§Ø± Ù‚ÛŒÙ…Øª Ø§Ù…Ù„Ø§Ú©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<!-- Header -->
<header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">Ø³Ø§Ù…Ø§Ù†Ù‡ ØªØ­Ù„ÛŒÙ„ Ø§Ù…Ù„Ø§Ú© Ø¯ÛŒÙˆØ§Ø±</h1>
        <nav class="space-x-2 space-x-reverse">
            <a href="index.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Ø®Ø§Ù†Ù‡</a>
            <a href="charts.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ
                ØªØ­Ù„ÛŒÙ„ÛŒ</a>
            <a href="predict.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ØªØ®Ù…ÛŒÙ† Ù‚ÛŒÙ…Øª</a>
        </nav>
    </div>
</header>

<body class="bg-gradient-to-b from-blue-100 to-blue-50 min-h-screen font-sans pb-20">

<div class="max-w-3xl mx-auto mt-4 bg-white p-4 rounded-2xl shadow text-sm leading-tight">
    <h4 class="text-2xl font-bold mb-6 text-center">Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª Ù‚ÛŒÙ…Øª Ø§Ù…Ù„Ø§Ú©</h4>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" dir="rtl">
        <div>
            <label class="block mb-1 font-medium">Ø´Ù‡Ø±</label>
            <select id="citySelect" class="w-full border p-2 rounded"></select>
        </div>
        <div>
            <label class="block mb-1 font-medium">Ù†ÙˆØ¹ Ø¢Ú¯Ù‡ÛŒ</label>
            <select id="groupSelect" class="w-full border p-2 rounded">
                <option value="">Ù‡Ù…Ù‡</option>
            </select>
        </div>
        <div>
            <label class="block mb-1 font-medium">Ù†ÙˆØ¹ Ù…Ù„Ú©</label>
            <select id="categorySelect" class="w-full border p-2 rounded">
                <option value="">Ù‡Ù…Ù‡</option>
            </select>
        </div>
    </div>

    <button onclick="loadChart()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded mb-4 w-full">Ù†Ù…Ø§ÛŒØ´
        Ù†Ù…ÙˆØ¯Ø§Ø±
    </button>

    <!-- ðŸ‘‡ ØªØºÛŒÛŒØ± Ø§Ø±ØªÙØ§Ø¹ Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <canvas id="priceChart" height="100"></canvas>
</div>

<script>
    let chart;

    async function fetchData() {
        const [cities, groups, categories] = await Promise.all([
            fetch('http://localhost:8080/rest/reale/state/cities').then(res => res.json()),
            fetch('http://localhost:8080/rest/reale/state/groups').then(res => res.json()),
            fetch('http://localhost:8080/rest/reale/state/categories').then(res => res.json())
        ]);

        fillSelect(document.getElementById("citySelect"), cities, "id", "name");
        fillSelect(document.getElementById("groupSelect"), groups, "code", "title", true);
        fillSelect(document.getElementById("categorySelect"), categories, "code", "title", true);
    }

    function fillSelect(select, data, valueKey, textKey, addAllOption = false) {
        select.innerHTML = "";
        if (addAllOption) {
            const allOption = document.createElement("option");
            allOption.value = "";
            allOption.textContent = "Ù‡Ù…Ù‡";
            select.appendChild(allOption);
        }

        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item[valueKey];
            opt.textContent = item[textKey];
            select.appendChild(opt);
        });
    }

    async function loadChart() {
        const cityId = document.getElementById("citySelect").value;
        const groupCode = document.getElementById("groupSelect").value;
        const categoryCode = document.getElementById("categorySelect").value;

        if (!cityId) {
            alert("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø´Ù‡Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
            return;
        }

        let url = `http://localhost:8080/rest/reale/state/chart?cityId=${cityId}`;
        if (groupCode) url += `&groupCode=${groupCode}`;
        if (categoryCode) url += `&categoryCode=${categoryCode}`;

        try {
            const data = await fetch(url).then(res => res.json());

            const labels = Object.keys(data);
            const values = Object.values(data).map(Number);

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù…ØªØ±ÛŒÙ† Ùˆ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø±
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);

            // Ú©Ù… Ùˆ Ø²ÛŒØ§Ø¯ Ú©Ø±Ø¯Ù† Ù…Ø­Ø¯ÙˆØ¯Ù‡
            const minY = Math.max(0, Math.floor(minValue) - 2); // Ø­Ø¯Ø§Ù‚Ù„ Û°
            const maxY = Math.ceil(maxValue) + 2;

            if (chart) chart.destroy();

            const ctx = document.getElementById("priceChart").getContext("2d");
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª (Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ ØªÙˆÙ…Ø§Ù†)",
                        data: values,
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: minY,
                            maxY: maxY,
                            ticks: {
                                callback: function (value, index, values) {
                                    // Ø§Ø² Ø¨ÛŒÙ† Ø¨Ø±Ø¯Ù† Ø§Ø¹Ø´Ø§Ø± Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Math.round Ùˆ ÙØ±Ù…Øª Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†
                                    return new Intl.NumberFormat('fa-IR').format(Math.round(value)) + ' Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯';
                                },

                                stepSize: 1,
                            },
                            title: {
                                display: true,
                                text: "Ù‚ÛŒÙ…Øª Ø¨Ù‡ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ ØªÙˆÙ…Ø§Ù†"
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: "Ø³Ø§Ù„ Ø´Ù…Ø³ÛŒ"
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw} Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ ØªÙˆÙ…Ø§Ù†`
                            }
                        }
                    }
                }
            });
        } catch (e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±");
            console.error(e);
        }
    }

    window.onload = fetchData;
</script>

<!-- Footer -->
<footer class="bg-gray-800 text-white py-4 w-full text-center fixed bottom-0 left-0">
    <div class="max-w-6xl mx-auto">
        <p class="text-sm">
            Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø³Ø§ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù„Ø§Ú© Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø¯Ø± Ø¯ÛŒÙˆØ§Ø± Ø§Ø³Øª. ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡
            Ø¯ÛŒÙˆØ§Ø± Ø§Ø³Øª.
        </p>
    </div>
</footer>

</body>
</html>
